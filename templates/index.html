<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>{{ bot_name }}'s Assistant</title>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: Arial, sans-serif;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  Â  Â  background-color: #f4f4f4;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: center;
Â  Â  Â  Â  Â  Â  align-items: center;
Â  Â  Â  Â  Â  Â  min-height: 100vh;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-container {
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  border-radius: 8px;
Â  Â  Â  Â  Â  Â  box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  max-width: 600px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  Â  Â  height: 80vh;
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-header {
Â  Â  Â  Â  Â  Â  background-color: #007bff; /* Default blue for guest mode */
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  Â  Â  border-top-left-radius: 8px;
Â  Â  Â  Â  Â  Â  border-top-right-radius: 8px;
Â  Â  Â  Â  Â  Â  font-size: 1.2em;
Â  Â  Â  Â  Â  Â  transition: background-color 0.3s ease; /* Smooth transition for color change */
Â  Â  Â  Â  Â  Â  position: relative; /* Needed for positioning the logout button */
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-messages {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  padding: 20px;
Â  Â  Â  Â  Â  Â  overflow-y: auto;
Â  Â  Â  Â  Â  Â  background-color: #e9ecef;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #ddd;
Â  Â  Â  Â  }
Â  Â  Â  Â  .message {
Â  Â  Â  Â  Â  Â  margin-bottom: 15px;
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  flex-direction: column;
Â  Â  Â  Â  }
Â  Â  Â  Â  .message.user {
Â  Â  Â  Â  Â  Â  align-items: flex-end;
Â  Â  Â  Â  }
Â  Â  Â  Â  .message.bot {
Â  Â  Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  }
Â  Â  Â  Â  .message-bubble {
Â  Â  Â  Â  Â  Â  padding: 10px 15px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  max-width: 70%;
Â  Â  Â  Â  Â  Â  word-wrap: break-word;
Â  Â  Â  Â  }
Â  Â  Â  Â  .message.user .message-bubble {
Â  Â  Â  Â  Â  Â  background-color: #007bff;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border-bottom-right-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .message.bot .message-bubble {
Â  Â  Â  Â  Â  Â  background-color: #f0f0f0;
Â  Â  Â  Â  Â  Â  color: #333;
Â  Â  Â  Â  Â  Â  border-bottom-left-radius: 5px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-input-form {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  Â  Â  border-top: 1px solid #eee;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-input-form input[type="text"] {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  margin-right: 10px;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-input-form button {
Â  Â  Â  Â  Â  Â  background-color: #28a745;
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  border-radius: 20px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-size: 1em;
Â  Â  Â  Â  }
Â  Â  Â  Â  .chat-input-form button:hover {
Â  Â  Â  Â  Â  Â  background-color: #218838;
Â  Â  Â  Â  }
Â  Â  Â  Â  .logout-btn {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  top: 10px;
Â  Â  Â  Â  Â  Â  right: 15px;
Â  Â  Â  Â  Â  Â  background: rgba(255, 255, 255, 0.2);
Â  Â  Â  Â  Â  Â  color: white;
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  Â  Â  padding: 5px 10px;
Â  Â  Â  Â  Â  Â  border-radius: 5px;
Â  Â  Â  Â  Â  Â  text-decoration: none;
Â  Â  Â  Â  Â  Â  font-size: 0.8em;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body>
Â  Â  <div class="chat-container">
Â  Â  Â  Â  <div class="chat-header" id="chat-header">
Â  Â  Â  Â  Â  Â  {{ bot_name }}
Â  Â  Â  Â  Â  Â  <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="chat-messages" id="chat-messages">
Â  Â  Â  Â  Â  Â  <div class="message bot">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="message-bubble">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ðŸ‘‹ Hello! I'm {{ bot_name }}, {{ creator_name }}'s assistant. How can I help you today?
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <form class="chat-input-form" id="chat-form">
Â  Â  Â  Â  Â  Â  <input type="text" id="user-input" placeholder="Type your message..." autocomplete="off">
Â  Â  Â  Â  Â  Â  <button type="submit">Send</button>
Â  Â  Â  Â  </form>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  const botName = "{{ bot_name }}";
Â  Â  Â  Â  const creatorName = "{{ creator_name }}";

Â  Â  Â  Â  const chatForm = document.getElementById('chat-form');
Â  Â  Â  Â  const userInput = document.getElementById('user-input');
Â  Â  Â  Â  const chatMessages = document.getElementById('chat-messages');
Â  Â  Â  Â  const chatHeader = document.getElementById('chat-header');
        
        // This function will be called on page load to fetch the initial chat history
        async function fetchInitialChatHistory() {
            try {
                const response = await fetch('/get_chat_history');
                const data = await response.json();
                if (data.history) {
                    data.history.forEach(entry => {
                        appendMessage(entry.parts[0], entry.role);
                    });
                }
            } catch (error) {
                console.error('Error fetching initial chat history:', error);
            }
        }
        
        // Call the function when the page loads
        document.addEventListener('DOMContentLoaded', fetchInitialChatHistory);


Â  Â  Â  Â  chatForm.addEventListener('submit', async (event) => {
Â  Â  Â  Â  Â  Â  event.preventDefault(); // Prevent page reload
Â  Â  Â  Â  Â  Â  const message = userInput.value.trim();
Â  Â  Â  Â  Â  Â  if (message === '') return;

Â  Â  Â  Â  Â  Â  // Display user message
Â  Â  Â  Â  Â  Â  appendMessage(message, 'user');
Â  Â  Â  Â  Â  Â  userInput.value = ''; // Clear input field

Â  Â  Â  Â  Â  Â  // Show typing indicator or loading message
Â  Â  Â  Â  Â  Â  const loadingMessage = appendMessage('...', 'bot', true); // true for is_loading

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/chat', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/x-www-form-urlencoded',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: new URLSearchParams({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'user_input': message
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  // Remove loading message
Â  Â  Â  Â  Â  Â  Â  Â  chatMessages.removeChild(loadingMessage);

Â  Â  Â  Â  Â  Â  Â  Â  // Display bot response
Â  Â  Â  Â  Â  Â  Â  Â  appendMessage(data.response, 'bot');

Â  Â  Â  Â  Â  Â  Â  Â  // --- Update header color based on creator status ---
Â  Â  Â  Â  Â  Â  Â  Â  if (data.is_creator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatHeader.style.backgroundColor = "#dc3545"; // Red for creator
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatHeader.style.backgroundColor = "#007bff"; // Blue for guest
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error sending message:', error);
Â  Â  Â  Â  Â  Â  Â  Â  // Remove loading message
Â  Â  Â  Â  Â  Â  Â  Â  chatMessages.removeChild(loadingMessage);
Â  Â  Â  Â  Â  Â  Â  Â  appendMessage('Error: Could not get a response. Please try again.', 'bot');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  chatMessages.scrollTop = chatMessages.scrollHeight; // Scroll to bottom
Â  Â  Â  Â  });

Â  Â  Â  Â  function appendMessage(text, sender, isLoading = false) {
Â  Â  Â  Â  Â  Â  const messageDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  messageDiv.classList.add('message', sender);

Â  Â  Â  Â  Â  Â  const bubbleDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  bubbleDiv.classList.add('message-bubble');

Â  Â  Â  Â  Â  Â  if (isLoading) {
Â  Â  Â  Â  Â  Â  Â  Â  bubbleDiv.textContent = 'Thinking...';
Â  Â  Â  Â  Â  Â  Â  Â  bubbleDiv.classList.add('loading-dots'); // Add a class for potential animation
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  bubbleDiv.textContent = text;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  messageDiv.appendChild(bubbleDiv);
Â  Â  Â  Â  Â  Â  chatMessages.appendChild(messageDiv);
Â  Â  Â  Â  Â  Â  chatMessages.scrollTop = chatMessages.scrollHeight; // Auto-scroll
Â  Â  Â  Â  Â  Â  return messageDiv; // Return the message element so it can be removed if it's a loading message
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Initial header color setting on page load ---
Â  Â  Â  Â  // Fetch initial status to set header color immediately
Â  Â  Â  Â  async function setInitialHeaderColor() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/chat_status'); // A new endpoint to get just the status
Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data.is_creator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatHeader.style.backgroundColor = "#dc3545"; // Red
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  chatHeader.style.backgroundColor = "#007bff"; // Blue
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Error fetching initial status:', error);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  setInitialHeaderColor(); // Call on page load
Â  Â  </script>
</body>
</html>
